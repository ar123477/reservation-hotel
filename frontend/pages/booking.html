<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Réservation - TogoHotel Manager</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <link href="../css/style.css" rel="stylesheet">
</head>
<body>
    <!-- Navigation -->
    <nav class="navbar navbar-expand-lg navbar-dark bg-dark fixed-top">
        <div class="container">
            <a class="navbar-brand" href="../index.html">
                <i class="fas fa-hotel me-2"></i>TogoHotel Manager
            </a>
            <div class="collapse navbar-collapse">
                <ul class="navbar-nav me-auto">
                    <li class="nav-item">
                        <a class="nav-link" href="../index.html">Accueil</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="hotels.html">Hôtels</a>
                    </li>
                </ul>
                <div class="navbar-nav" id="authLinks">
                    <a class="nav-link" href="login.html">Connexion</a>
                    <a class="nav-link" href="signup.html">Inscription</a>
                </div>
                <div class="navbar-nav" id="userMenu" style="display: none;">
                    <li class="nav-item dropdown">
                        <a class="nav-link dropdown-toggle" href="#" role="button" data-bs-toggle="dropdown">
                            <i class="fas fa-user me-1"></i>
                            <span id="userName"></span>
                        </a>
                        <ul class="dropdown-menu" id="dashboardLinks">
                            <!-- Liens dynamiques selon le rôle -->
                        </ul>
                    </li>
                </div>
            </div>
        </div>
    </nav>

    <!-- Processus de Réservation -->
    <div class="container mt-5 pt-4">
        <div class="row">
            <div class="col-12">
                <nav aria-label="breadcrumb">
                    <ol class="breadcrumb">
                        <li class="breadcrumb-item"><a href="../index.html">Accueil</a></li>
                        <li class="breadcrumb-item"><a href="hotels.html">Hôtels</a></li>
                        <li class="breadcrumb-item active">Réservation</li>
                    </ol>
                </nav>
            </div>
        </div>

        <div class="row">
            <div class="col-lg-8">
                <div class="card">
                    <div class="card-header bg-primary text-white">
                        <h4 class="mb-0"><i class="fas fa-calendar-check me-2"></i>Détails de la réservation</h4>
                    </div>
                    <div class="card-body">
                        <form id="bookingForm" class="needs-validation" novalidate>
                            <!-- Informations de l'hôtel et chambre -->
                            <div id="bookingSummary" class="mb-4 p-3 bg-light rounded">
                                <!-- Rempli dynamiquement -->
                            </div>

                            <!-- Type de réservation -->
                            <div class="mb-4">
                                <h5>Type de réservation</h5>
                                <div class="form-check">
                                    <input class="form-check-input" type="radio" name="reservationType" 
                                           id="classique" value="classique" checked>
                                    <label class="form-check-label" for="classique">
                                        Séjour classique (par nuit)
                                    </label>
                                </div>
                                <div class="form-check">
                                    <input class="form-check-input" type="radio" name="reservationType" 
                                           id="horaire" value="horaire">
                                    <label class="form-check-label" for="horaire">
                                        Réservation horaire
                                    </label>
                                </div>
                            </div>

                            <!-- Dates pour séjour classique -->
                            <div id="classiqueDates" class="row mb-4">
                                <div class="col-md-6">
                                    <label for="dateArrivee" class="form-label">Date d'arrivée</label>
                                    <input type="date" class="form-control" id="dateArrivee" required>
                                    <div class="invalid-feedback">
                                        Veuillez sélectionner une date d'arrivée.
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <label for="dateDepart" class="form-label">Date de départ</label>
                                    <input type="date" class="form-control" id="dateDepart" required>
                                    <div class="invalid-feedback">
                                        Veuillez sélectionner une date de départ.
                                    </div>
                                </div>
                            </div>

                            <!-- Réservation horaire -->
                            <div id="horaireDates" class="row mb-4" style="display: none;">
                                <div class="col-md-6">
                                    <label for="dateHoraire" class="form-label">Date</label>
                                    <input type="date" class="form-control" id="dateHoraire">
                                </div>
                                <div class="col-md-3">
                                    <label for="heureArrivee" class="form-label">Heure d'arrivée</label>
                                    <input type="time" class="form-control" id="heureArrivee" value="14:00">
                                </div>
                                <div class="col-md-3">
                                    <label for="dureeHeures" class="form-label">Durée (heures)</label>
                                    <select class="form-select" id="dureeHeures">
                                        <option value="4">4 heures</option>
                                        <option value="8">8 heures</option>
                                        <option value="12">12 heures</option>
                                    </select>
                                </div>
                            </div>

                            <!-- Méthode de paiement -->
                            <div class="mb-4">
                                <h5>Méthode de paiement</h5>
                                <div class="form-check">
                                    <input class="form-check-input" type="radio" name="paymentMethod" 
                                           id="surPlace" value="sur_place" checked>
                                    <label class="form-check-label" for="surPlace">
                                        Payer sur place
                                    </label>
                                </div>
                                <div class="form-check">
                                    <input class="form-check-input" type="radio" name="paymentMethod" 
                                           id="enLigne" value="en_ligne">
                                    <label class="form-check-label" for="enLigne">
                                        Payer en ligne
                                    </label>
                                </div>
                            </div>

                            <!-- Informations personnelles -->
                            <div class="mb-4">
                                <h5>Informations personnelles</h5>
                                <div class="row">
                                    <div class="col-md-6 mb-3">
                                        <label for="clientPrenom" class="form-label">Prénom</label>
                                        <input type="text" class="form-control" id="clientPrenom" required>
                                    </div>
                                    <div class="col-md-6 mb-3">
                                        <label for="clientNom" class="form-label">Nom</label>
                                        <input type="text" class="form-control" id="clientNom" required>
                                    </div>
                                </div>
                                <div class="row">
                                    <div class="col-md-6 mb-3">
                                        <label for="clientEmail" class="form-label">Email</label>
                                        <input type="email" class="form-control" id="clientEmail" required>
                                    </div>
                                    <div class="col-md-6 mb-3">
                                        <label for="clientTelephone" class="form-label">Téléphone</label>
                                        <input type="tel" class="form-control" id="clientTelephone" required>
                                    </div>
                                </div>
                            </div>

                            <button type="submit" class="btn btn-primary btn-lg w-100" id="bookButton">
                                <i class="fas fa-check me-2"></i>Confirmer la réservation
                            </button>
                        </form>
                    </div>
                </div>
            </div>

            <!-- Récapitulatif -->
            <div class="col-lg-4">
                <div class="card sticky-top" style="top: 100px;">
                    <div class="card-header bg-success text-white">
                        <h5 class="mb-0"><i class="fas fa-receipt me-2"></i>Récapitulatif</h5>
                    </div>
                    <div class="card-body">
                        <div id="priceSummary">
                            <!-- Rempli dynamiquement -->
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="../js/auth.js"></script>
    <script src="../js/api.js"></script>
    <script src="../js/main.js"></script>
    <script>
        let currentHotel = null;
        let currentRoomType = null;
        let roomPrice = 0;

        // Types de chambres avec prix
        const roomPrices = {
            standard: 35000,
            junior: 55000,
            executive: 85000,
            presidentielle: 150000
        };

        // Initialisation
        document.addEventListener('DOMContentLoaded', function() {
            // Vérifier l'authentification
            if (!Auth.requireAuth()) return;

            Auth.updateNavigation();
            loadBookingData();
            setupEventListeners();
            prefillUserData();
        });

        // Charger les données de réservation
        async function loadBookingData() {
            const urlParams = new URLSearchParams(window.location.search);
            const hotelId = urlParams.get('hotelId');
            const roomType = urlParams.get('roomType');

            if (!hotelId || !roomType) {
                Utils.showError(document.getElementById('bookingSummary'), 'Paramètres de réservation manquants.');
                return;
            }

            try {
                const hotel = await API.getHotel(hotelId);
                currentHotel = hotel;
                currentRoomType = roomType;
                roomPrice = roomPrices[roomType] || 35000;

                displayBookingSummary(hotel, roomType);
                updatePriceSummary();
                setupDateConstraints();

            } catch (error) {
                console.error('Erreur lors du chargement des données:', error);
                Utils.showError(document.getElementById('bookingSummary'), 'Impossible de charger les détails de la réservation.');
            }
        }

        // Afficher le résumé de la réservation
        function displayBookingSummary(hotel, roomType) {
            const container = document.getElementById('bookingSummary');
            const roomLabel = Utils.getRoomTypeLabel(roomType);

            container.innerHTML = `
                <div class="row">
                    <div class="col-md-8">
                        <h5 class="mb-2">${hotel.nom}</h5>
                        <p class="text-muted mb-1">
                            <i class="fas fa-map-marker-alt text-danger me-1"></i>${hotel.ville}
                        </p>
                        <p class="text-muted mb-0">
                            <i class="fas fa-bed text-primary me-1"></i>${roomLabel}
                        </p>
                    </div>
                    <div class="col-md-4 text-end">
                        <div class="h5 text-primary mb-0">${API.formatPrice(roomPrice)}</div>
                        <small class="text-muted">par nuit</small>
                    </div>
                </div>
            `;
        }

        // Configurer les contraintes de date
        function setupDateConstraints() {
            const today = new Date().toISOString().split('T')[0];
            document.getElementById('dateArrivee').min = today;
            document.getElementById('dateHoraire').min = today;
        }

        // Configurer les écouteurs d'événements
        function setupEventListeners() {
            // Basculer entre les types de réservation
            document.querySelectorAll('input[name="reservationType"]').forEach(radio => {
                radio.addEventListener('change', function() {
                    const isClassique = this.value === 'classique';
                    document.getElementById('classiqueDates').style.display = isClassique ? 'block' : 'none';
                    document.getElementById('horaireDates').style.display = isClassique ? 'none' : 'block';
                    
                    if (isClassique) {
                        document.getElementById('dateArrivee').required = true;
                        document.getElementById('dateDepart').required = true;
                    } else {
                        document.getElementById('dateArrivee').required = false;
                        document.getElementById('dateDepart').required = false;
                    }
                    
                    updatePriceSummary();
                });
            });

            // Mettre à jour les prix quand les dates changent
            document.getElementById('dateArrivee').addEventListener('change', updatePriceSummary);
            document.getElementById('dateDepart').addEventListener('change', updatePriceSummary);
            document.getElementById('dureeHeures').addEventListener('change', updatePriceSummary);
        }

        // Pré-remplir les données utilisateur
        function prefillUserData() {
            const user = Auth.getUser();
            if (user) {
                document.getElementById('clientPrenom').value = user.prenom || '';
                document.getElementById('clientNom').value = user.nom || '';
                document.getElementById('clientEmail').value = user.email || '';
                document.getElementById('clientTelephone').value = user.telephone || '';
            }
        }

        // Mettre à jour le résumé des prix
        function updatePriceSummary() {
            const container = document.getElementById('priceSummary');
            const reservationType = document.querySelector('input[name="reservationType"]:checked').value;
            
            let total = 0;
            let details = '';

            if (reservationType === 'classique') {
                const dateArrivee = document.getElementById('dateArrivee').value;
                const dateDepart = document.getElementById('dateDepart').value;
                
                if (dateArrivee && dateDepart) {
                    const nights = API.calculateTotalNights(dateArrivee, dateDepart);
                    total = roomPrice * nights;
                    details = `
                        <div class="d-flex justify-content-between mb-2">
                            <span>${nights} nuit(s) × ${API.formatPrice(roomPrice)}</span>
                            <span>${API.formatPrice(roomPrice * nights)}</span>
                        </div>
                    `;
                }
            } else {
                const hours = parseInt(document.getElementById('dureeHeures').value);
                total = API.calculateHourlyPrice(roomPrice, hours);
                details = `
                    <div class="d-flex justify-content-between mb-2">
                        <span>${hours} heure(s)</span>
                        <span>${API.formatPrice(total)}</span>
                    </div>
                `;
            }

            const taxes = Math.round(total * 0.18); // 18% de taxes
            const grandTotal = total + taxes;

            container.innerHTML = `
                ${details}
                <div class="d-flex justify-content-between mb-2">
                    <span>Taxes et frais</span>
                    <span>${API.formatPrice(taxes)}</span>
                </div>
                <hr>
                <div class="d-flex justify-content-between fw-bold">
                    <span>Total</span>
                    <span class="h5 text-success">${API.formatPrice(grandTotal)}</span>
                </div>
                <small class="text-muted d-block mt-2">
                    <i class="fas fa-info-circle me-1"></i>
                    ${reservationType === 'classique' ? 'Prix pour tout le séjour' : 'Prix pour la durée sélectionnée'}
                </small>
            `;
        }

        // Soumettre le formulaire de réservation
        document.getElementById('bookingForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            if (!this.checkValidity()) {
                e.stopPropagation();
                this.classList.add('was-validated');
                return;
            }

            const reservationType = document.querySelector('input[name="reservationType"]:checked').value;
            const paymentMethod = document.querySelector('input[name="paymentMethod"]:checked').value;

            let dateArrivee, dateDepart, dureeHeures;
            let total = 0;

            if (reservationType === 'classique') {
                dateArrivee = document.getElementById('dateArrivee').value + 'T14:00:00';
                dateDepart = document.getElementById('dateDepart').value + 'T12:00:00';
                const nights = API.calculateTotalNights(dateArrivee, dateDepart);
                total = roomPrice * nights;
            } else {
                const selectedDate = document.getElementById('dateHoraire').value;
                const heureArrivee = document.getElementById('heureArrivee').value;
                dureeHeures = parseInt(document.getElementById('dureeHeures').value);
                dateArrivee = `${selectedDate}T${heureArrivee}:00`;
                total = API.calculateHourlyPrice(roomPrice, dureeHeures);
            }

            const reservationData = {
                hotel_id: currentHotel.id,
                type_chambre: currentRoomType,
                date_arrivee: dateArrivee,
                date_depart: reservationType === 'classique' ? dateDepart : null,
                type_reservation: reservationType,
                duree_heures: dureeHeures || null,
                methode_paiement: paymentMethod,
                montant_total: total + Math.round(total * 0.18) // Total avec taxes
            };

            const bookButton = document.getElementById('bookButton');
            bookButton.disabled = true;
            bookButton.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>Réservation en cours...';

            try {
                const result = await API.createReservation(reservationData);
                
                Utils.showSuccess('Réservation confirmée ! Redirection...');
                
                setTimeout(() => {
                    window.location.href = 'my-bookings.html';
                }, 2000);

            } catch (error) {
                console.error('Erreur de réservation:', error);
                
                Utils.showError(document.getElementById('bookingForm'), 
                    `Erreur lors de la réservation: ${error.message}`);
                
                bookButton.disabled = false;
                bookButton.innerHTML = '<i class="fas fa-check me-2"></i>Confirmer la réservation';
            }
        });
    </script>
</body>
</html>