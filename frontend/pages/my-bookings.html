<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mes Réservations - TogoHotel Manager</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <link href="../css/style.css" rel="stylesheet">
</head>
<body>
    <!-- Navigation -->
    <nav class="navbar navbar-expand-lg navbar-dark bg-dark fixed-top">
        <div class="container">
            <a class="navbar-brand" href="../index.html">
                <i class="fas fa-hotel me-2"></i>TogoHotel Manager
            </a>
            <div class="collapse navbar-collapse">
                <ul class="navbar-nav me-auto">
                    <li class="nav-item">
                        <a class="nav-link" href="../index.html">Accueil</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="hotels.html">Hôtels</a>
                    </li>
                </ul>
                <div class="navbar-nav" id="userMenu">
                    <li class="nav-item dropdown">
                        <a class="nav-link dropdown-toggle" href="#" role="button" data-bs-toggle="dropdown">
                            <i class="fas fa-user me-1"></i>
                            <span id="userName"></span>
                        </a>
                        <ul class="dropdown-menu" id="dashboardLinks">
                            <li><a class="dropdown-item active" href="my-bookings.html">
                                <i class="fas fa-calendar-alt me-2"></i>Mes réservations
                            </a></li>
                            <li><a class="dropdown-item" href="profile.html">
                                <i class="fas fa-user me-2"></i>Mon profil
                            </a></li>
                            <li><hr class="dropdown-divider"></li>
                            <li><a class="dropdown-item" href="#" onclick="Auth.logout()">
                                <i class="fas fa-sign-out-alt me-2"></i>Déconnexion
                            </a></li>
                        </ul>
                    </li>
                </div>
            </div>
        </div>
    </nav>

    <!-- Contenu Principal -->
    <div class="container mt-5 pt-4">
        <div class="row">
            <div class="col-12">
                <div class="d-flex justify-content-between align-items-center mb-4">
                    <h1 class="h3 mb-0">
                        <i class="fas fa-calendar-alt me-2 text-primary"></i>Mes Réservations
                    </h1>
                    <a href="hotels.html" class="btn btn-primary">
                        <i class="fas fa-plus me-2"></i>Nouvelle réservation
                    </a>
                </div>

                <!-- Filtres -->
                <div class="card mb-4">
                    <div class="card-body">
                        <div class="row g-3">
                            <div class="col-md-4">
                                <label class="form-label">Statut</label>
                                <select class="form-select" id="statusFilter" onchange="filterReservations()">
                                    <option value="">Tous les statuts</option>
                                    <option value="confirmee">Confirmées</option>
                                    <option value="en_cours">En cours</option>
                                    <option value="terminee">Terminées</option>
                                    <option value="annulee">Annulées</option>
                                </select>
                            </div>
                            <div class="col-md-4">
                                <label class="form-label">Période</label>
                                <select class="form-select" id="periodFilter" onchange="filterReservations()">
                                    <option value="">Toutes les périodes</option>
                                    <option value="future">À venir</option>
                                    <option value="past">Passées</option>
                                    <option value="current">En cours</option>
                                </select>
                            </div>
                            <div class="col-md-4">
                                <label class="form-label">Recherche</label>
                                <input type="text" class="form-control" id="searchFilter" placeholder="Rechercher..." onkeyup="filterReservations()">
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Liste des Réservations -->
                <div id="reservationsList">
                    <!-- Les réservations seront chargées ici -->
                </div>
            </div>
        </div>
    </div>

    <!-- Modal d'Annulation -->
    <div class="modal fade" id="cancelModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Annuler la réservation</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <p>Êtes-vous sûr de vouloir annuler cette réservation ?</p>
                    <div class="alert alert-warning">
                        <i class="fas fa-exclamation-triangle me-2"></i>
                        L'annulation est possible jusqu'à 48 heures avant la date d'arrivée.
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Retour</button>
                    <button type="button" class="btn btn-danger" id="confirmCancel">Confirmer l'annulation</button>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="../js/auth.js"></script>
    <script src="../js/api.js"></script>
    <script src="../js/main.js"></script>
    <script>
        let allReservations = [];
        let cancelReservationId = null;

        // Initialisation
        document.addEventListener('DOMContentLoaded', function() {
            if (!Auth.requireAuth()) return;
            Auth.updateNavigation();
            loadReservations();
        });

        // Charger les réservations
        async function loadReservations() {
            try {
                const reservations = await API.getMyReservations();
                allReservations = reservations;
                displayReservations(reservations);
            } catch (error) {
                console.error('Erreur lors du chargement des réservations:', error);
                Utils.showError(document.getElementById('reservationsList'), 
                    'Impossible de charger vos réservations.');
            }
        }

        // Afficher les réservations
        function displayReservations(reservations) {
            const container = document.getElementById('reservationsList');
            
            if (reservations.length === 0) {
                container.innerHTML = `
                    <div class="card">
                        <div class="card-body text-center py-5">
                            <i class="fas fa-calendar-times fa-3x text-muted mb-3"></i>
                            <h4 class="text-muted">Aucune réservation</h4>
                            <p class="text-muted">Vous n'avez pas encore de réservation.</p>
                            <a href="hotels.html" class="btn btn-primary">
                                <i class="fas fa-hotel me-2"></i>Découvrir nos hôtels
                            </a>
                        </div>
                    </div>
                `;
                return;
            }

            let html = '';
            reservations.forEach(reservation => {
                const canCancel = canReservationBeCancelled(reservation);
                const isFuture = new Date(reservation.date_arrivee) > new Date();
                
                html += `
                    <div class="card mb-3 reservation-card">
                        <div class="card-body">
                            <div class="row">
                                <div class="col-md-8">
                                    <div class="d-flex justify-content-between align-items-start mb-2">
                                        <h5 class="card-title mb-0">
                                            ${reservation.hotel_nom}
                                            <span class="badge ${getStatusBadgeClass(reservation.statut)} ms-2">
                                                ${getStatusText(reservation.statut)}
                                            </span>
                                        </h5>
                                        <div class="text-end">
                                            <div class="h5 text-primary mb-0">
                                                ${API.formatPrice(reservation.montant_total)}
                                            </div>
                                            <small class="text-muted">${reservation.numero_reservation}</small>
                                        </div>
                                    </div>
                                    
                                    <div class="row mb-3">
                                        <div class="col-sm-6">
                                            <small class="text-muted d-block">Type de chambre</small>
                                            <strong>${Utils.getRoomTypeLabel(reservation.type_chambre)}</strong>
                                        </div>
                                        <div class="col-sm-6">
                                            <small class="text-muted d-block">Chambre</small>
                                            <strong>${reservation.numero_chambre || 'Non assignée'}</strong>
                                        </div>
                                    </div>

                                    <div class="row">
                                        <div class="col-sm-6">
                                            <small class="text-muted d-block">Arrivée</small>
                                            <strong>${API.formatDateTime(reservation.date_arrivee)}</strong>
                                        </div>
                                        <div class="col-sm-6">
                                            <small class="text-muted d-block">Départ</small>
                                            <strong>${reservation.date_depart ? API.formatDateTime(reservation.date_depart) : 'Réservation horaire'}</strong>
                                        </div>
                                    </div>
                                </div>
                                
                                <div class="col-md-4 border-start">
                                    <div class="d-flex flex-column h-100">
                                        <div class="mb-2">
                                            <small class="text-muted d-block">Statut paiement</small>
                                            <span class="badge ${getPaymentStatusBadgeClass(reservation.statut_paiement)}">
                                                ${getPaymentStatusText(reservation.statut_paiement)}
                                            </span>
                                        </div>
                                        
                                        <div class="mb-2">
                                            <small class="text-muted d-block">Méthode</small>
                                            <span>${getPaymentMethodText(reservation.methode_paiement)}</span>
                                        </div>

                                        <div class="mt-auto">
                                            ${canCancel ? `
                                                <button class="btn btn-outline-danger btn-sm w-100 mb-2" 
                                                        onclick="showCancelModal(${reservation.id})">
                                                    <i class="fas fa-times me-1"></i>Annuler
                                                </button>
                                            ` : ''}
                                            
                                            ${isFuture && reservation.statut === 'confirmee' ? `
                                                <button class="btn btn-outline-primary btn-sm w-100" 
                                                        onclick="showReservationDetails(${reservation.id})">
                                                    <i class="fas fa-info-circle me-1"></i>Détails
                                                </button>
                                            ` : ''}
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
            });

            container.innerHTML = html;
        }

        // Filtrer les réservations
        function filterReservations() {
            const statusFilter = document.getElementById('statusFilter').value;
            const periodFilter = document.getElementById('periodFilter').value;
            const searchFilter = document.getElementById('searchFilter').value.toLowerCase();

            let filtered = allReservations;

            if (statusFilter) {
                filtered = filtered.filter(r => r.statut === statusFilter);
            }

            if (periodFilter) {
                const now = new Date();
                switch (periodFilter) {
                    case 'future':
                        filtered = filtered.filter(r => new Date(r.date_arrivee) > now);
                        break;
                    case 'past':
                        filtered = filtered.filter(r => new Date(r.date_depart) < now);
                        break;
                    case 'current':
                        filtered = filtered.filter(r => 
                            new Date(r.date_arrivee) <= now && new Date(r.date_depart) >= now
                        );
                        break;
                }
            }

            if (searchFilter) {
                filtered = filtered.filter(r => 
                    r.hotel_nom.toLowerCase().includes(searchFilter) ||
                    r.numero_reservation.toLowerCase().includes(searchFilter)
                );
            }

            displayReservations(filtered);
        }

        // Vérifier si une réservation peut être annulée
        function canReservationBeCancelled(reservation) {
            if (reservation.statut !== 'confirmee') return false;
            
            const arrivalDate = new Date(reservation.date_arrivee);
            const now = new Date();
            const hoursDifference = (arrivalDate - now) / (1000 * 60 * 60);
            
            return hoursDifference > 48;
        }

        // Afficher le modal d'annulation
        function showCancelModal(reservationId) {
            cancelReservationId = reservationId;
            const modal = new bootstrap.Modal(document.getElementById('cancelModal'));
            modal.show();
        }

        // Confirmer l'annulation
        document.getElementById('confirmCancel').addEventListener('click', async function() {
            if (!cancelReservationId) return;

            const button = this;
            button.disabled = true;
            button.innerHTML = '<i class="fas fa-spinner fa-spin me-1"></i>Annulation...';

            try {
                await API.cancelReservation(cancelReservationId);
                
                Utils.showSuccess('Réservation annulée avec succès !');
                
                // Fermer le modal et recharger les réservations
                const modal = bootstrap.Modal.getInstance(document.getElementById('cancelModal'));
                modal.hide();
                
                setTimeout(() => {
                    loadReservations();
                }, 1000);

            } catch (error) {
                console.error('Erreur lors de l\'annulation:', error);
                Utils.showError(document.getElementById('cancelModal'), 
                    `Erreur lors de l'annulation: ${error.message}`);
            } finally {
                button.disabled = false;
                button.innerHTML = 'Confirmer l\'annulation';
            }
        });

        // Afficher les détails d'une réservation
        function showReservationDetails(reservationId) {
            const reservation = allReservations.find(r => r.id === reservationId);
            if (!reservation) return;

            const modalHTML = `
                <div class="modal fade" id="detailsModal" tabindex="-1">
                    <div class="modal-dialog modal-lg">
                        <div class="modal-content">
                            <div class="modal-header">
                                <h5 class="modal-title">Détails de la réservation</h5>
                                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                            </div>
                            <div class="modal-body">
                                <div class="row">
                                    <div class="col-md-6">
                                        <h6>Informations de l'hôtel</h6>
                                        <p><strong>${reservation.hotel_nom}</strong></p>
                                        <p class="text-muted">${reservation.numero_reservation}</p>
                                    </div>
                                    <div class="col-md-6">
                                        <h6>Chambre</h6>
                                        <p><strong>${Utils.getRoomTypeLabel(reservation.type_chambre)}</strong></p>
                                        <p class="text-muted">${reservation.numero_chambre || 'Non assignée'}</p>
                                    </div>
                                </div>
                                <hr>
                                <div class="row">
                                    <div class="col-md-6">
                                        <h6>Dates</h6>
                                        <p><strong>Arrivée:</strong> ${API.formatDateTime(reservation.date_arrivee)}</p>
                                        <p><strong>Départ:</strong> ${reservation.date_depart ? API.formatDateTime(reservation.date_depart) : 'Réservation horaire'}</p>
                                    </div>
                                    <div class="col-md-6">
                                        <h6>Paiement</h6>
                                        <p><strong>Total:</strong> ${API.formatPrice(reservation.montant_total)}</p>
                                        <p><strong>Méthode:</strong> ${getPaymentMethodText(reservation.methode_paiement)}</p>
                                        <p><strong>Statut:</strong> ${getPaymentStatusText(reservation.statut_paiement)}</p>
                                    </div>
                                </div>
                            </div>
                            <div class="modal-footer">
                                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Fermer</button>
                            </div>
                        </div>
                    </div>
                </div>
            `;

            const modalContainer = document.createElement('div');
            modalContainer.innerHTML = modalHTML;
            document.body.appendChild(modalContainer);

            const modal = new bootstrap.Modal(document.getElementById('detailsModal'));
            modal.show();

            modalContainer.addEventListener('hidden.bs.modal', () => {
                document.body.removeChild(modalContainer);
            });
        }

        // Utilitaires pour les statuts
        function getStatusText(status) {
            const texts = {
                'confirmee': 'Confirmée',
                'en_attente': 'En attente',
                'annulee': 'Annulée',
                'terminee': 'Terminée',
                'en_cours': 'En cours'
            };
            return texts[status] || status;
        }

        function getStatusBadgeClass(status) {
            const classes = {
                'confirmee': 'bg-success',
                'en_attente': 'bg-warning',
                'annulee': 'bg-danger',
                'terminee': 'bg-info',
                'en_cours': 'bg-primary'
            };
            return classes[status] || 'bg-secondary';
        }

        function getPaymentStatusText(status) {
            const texts = {
                'en_attente': 'En attente',
                'paye_online': 'Payé en ligne',
                'a_payer_sur_place': 'À payer sur place'
            };
            return texts[status] || status;
        }

        function getPaymentStatusBadgeClass(status) {
            const classes = {
                'en_attente': 'bg-warning',
                'paye_online': 'bg-success',
                'a_payer_sur_place': 'bg-info'
            };
            return classes[status] || 'bg-secondary';
        }

        function getPaymentMethodText(method) {
            const texts = {
                'en_ligne': 'En ligne',
                'sur_place': 'Sur place'
            };
            return texts[method] || method;
        }
    </script>
</body>
</html>