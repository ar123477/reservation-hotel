<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mon Profil - TogoHotel Manager</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <link href="../css/style.css" rel="stylesheet">
</head>
<body>
    <!-- Navigation -->
    <nav class="navbar navbar-expand-lg navbar-dark bg-dark fixed-top">
        <div class="container">
            <a class="navbar-brand" href="../index.html">
                <i class="fas fa-hotel me-2"></i>TogoHotel Manager
            </a>
            <div class="collapse navbar-collapse">
                <ul class="navbar-nav me-auto">
                    <li class="nav-item">
                        <a class="nav-link" href="../index.html">Accueil</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="hotels.html">Hôtels</a>
                    </li>
                </ul>
                <div class="navbar-nav" id="userMenu">
                    <li class="nav-item dropdown">
                        <a class="nav-link dropdown-toggle" href="#" role="button" data-bs-toggle="dropdown">
                            <i class="fas fa-user me-1"></i>
                            <span id="userName"></span>
                        </a>
                        <ul class="dropdown-menu" id="dashboardLinks">
                            <li><a class="dropdown-item" href="my-bookings.html">
                                <i class="fas fa-calendar-alt me-2"></i>Mes réservations
                            </a></li>
                            <li><a class="dropdown-item active" href="profile.html">
                                <i class="fas fa-user me-2"></i>Mon profil
                            </a></li>
                            <li><hr class="dropdown-divider"></li>
                            <li><a class="dropdown-item" href="#" onclick="Auth.logout()">
                                <i class="fas fa-sign-out-alt me-2"></i>Déconnexion
                            </a></li>
                        </ul>
                    </li>
                </div>
            </div>
        </div>
    </nav>

    <!-- Contenu Principal -->
    <div class="container mt-5 pt-4">
        <div class="row">
            <div class="col-lg-4">
                <!-- Carte de profil -->
                <div class="card mb-4">
                    <div class="card-body text-center">
                        <div class="mb-3">
                            <div class="bg-primary rounded-circle d-inline-flex align-items-center justify-content-center" 
                                 style="width: 80px; height: 80px;">
                                <i class="fas fa-user fa-2x text-white"></i>
                            </div>
                        </div>
                        <h4 id="profileName" class="card-title mb-1"></h4>
                        <p class="text-muted mb-2" id="profileRole"></p>
                        <p class="text-muted small" id="profileEmail"></p>
                        <div class="mt-3">
                            <span class="badge bg-primary" id="profileSince"></span>
                        </div>
                    </div>
                </div>

                <!-- Statistiques -->
                <div class="card">
                    <div class="card-header">
                        <h6 class="mb-0"><i class="fas fa-chart-bar me-2"></i>Statistiques</h6>
                    </div>
                    <div class="card-body">
                        <div class="row text-center">
                            <div class="col-6 mb-3">
                                <div class="h4 text-primary mb-1" id="totalBookings">0</div>
                                <small class="text-muted">Réservations</small>
                            </div>
                            <div class="col-6 mb-3">
                                <div class="h4 text-success mb-1" id="totalSpent">0 FCFA</div>
                                <small class="text-muted">Total dépensé</small>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="col-lg-8">
                <!-- Informations personnelles -->
                <div class="card mb-4">
                    <div class="card-header">
                        <h5 class="mb-0"><i class="fas fa-user-edit me-2"></i>Informations personnelles</h5>
                    </div>
                    <div class="card-body">
                        <form id="profileForm" class="needs-validation" novalidate>
                            <div class="row">
                                <div class="col-md-6 mb-3">
                                    <label for="editPrenom" class="form-label">Prénom</label>
                                    <input type="text" class="form-control" id="editPrenom" required>
                                    <div class="invalid-feedback">
                                        Veuillez entrer votre prénom.
                                    </div>
                                </div>
                                <div class="col-md-6 mb-3">
                                    <label for="editNom" class="form-label">Nom</label>
                                    <input type="text" class="form-control" id="editNom" required>
                                    <div class="invalid-feedback">
                                        Veuillez entrer votre nom.
                                    </div>
                                </div>
                            </div>
                            <div class="mb-3">
                                <label for="editEmail" class="form-label">Adresse email</label>
                                <input type="email" class="form-control" id="editEmail" readonly>
                                <div class="form-text">
                                    L'adresse email ne peut pas être modifiée.
                                </div>
                            </div>
                            <div class="mb-3">
                                <label for="editTelephone" class="form-label">Téléphone</label>
                                <input type="tel" class="form-control" id="editTelephone" 
                                       placeholder="+228 12 34 56 78">
                            </div>
                            <button type="submit" class="btn btn-primary" id="saveProfileBtn">
                                <i class="fas fa-save me-2"></i>Enregistrer les modifications
                            </button>
                        </form>
                    </div>
                </div>

                <!-- Changement de mot de passe -->
                <div class="card">
                    <div class="card-header">
                        <h5 class="mb-0"><i class="fas fa-lock me-2"></i>Changement de mot de passe</h5>
                    </div>
                    <div class="card-body">
                        <form id="passwordForm" class="needs-validation" novalidate>
                            <div class="mb-3">
                                <label for="currentPassword" class="form-label">Mot de passe actuel</label>
                                <input type="password" class="form-control" id="currentPassword" required>
                                <div class="invalid-feedback">
                                    Veuillez entrer votre mot de passe actuel.
                                </div>
                            </div>
                            <div class="mb-3">
                                <label for="newPassword" class="form-label">Nouveau mot de passe</label>
                                <input type="password" class="form-control" id="newPassword" 
                                       minlength="6" required>
                                <div class="invalid-feedback">
                                    Le mot de passe doit contenir au moins 6 caractères.
                                </div>
                                <div class="form-text">
                                    Le mot de passe doit contenir au moins 6 caractères.
                                </div>
                            </div>
                            <div class="mb-3">
                                <label for="confirmNewPassword" class="form-label">Confirmer le nouveau mot de passe</label>
                                <input type="password" class="form-control" id="confirmNewPassword" required>
                                <div class="invalid-feedback">
                                    Les mots de passe ne correspondent pas.
                                </div>
                            </div>
                            <button type="submit" class="btn btn-warning" id="changePasswordBtn">
                                <i class="fas fa-key me-2"></i>Changer le mot de passe
                            </button>
                        </form>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="../js/auth.js"></script>
    <script src="../js/api.js"></script>
    <script src="../js/main.js"></script>
    <script>
        // Initialisation
        document.addEventListener('DOMContentLoaded', function() {
            if (!Auth.requireAuth()) return;
            Auth.updateNavigation();
            loadProfileData();
            setupEventListeners();
        });

        // Charger les données du profil
        function loadProfileData() {
            const user = Auth.getUser();
            if (!user) return;

            // Informations personnelles
            document.getElementById('profileName').textContent = `${user.prenom} ${user.nom}`;
            document.getElementById('profileRole').textContent = getRoleText(user.role);
            document.getElementById('profileEmail').textContent = user.email;
            document.getElementById('profileSince').textContent = `Membre depuis ${new Date().getFullYear()}`;

            // Formulaire d'édition
            document.getElementById('editPrenom').value = user.prenom || '';
            document.getElementById('editNom').value = user.nom || '';
            document.getElementById('editEmail').value = user.email || '';
            document.getElementById('editTelephone').value = user.telephone || '';

            // Charger les statistiques
            loadUserStats();
        }

        // Charger les statistiques utilisateur
        async function loadUserStats() {
            try {
                const reservations = await API.getMyReservations();
                
                const totalBookings = reservations.length;
                const totalSpent = reservations
                    .filter(r => r.statut !== 'annulee')
                    .reduce((sum, r) => sum + parseFloat(r.montant_total), 0);

                document.getElementById('totalBookings').textContent = totalBookings;
                document.getElementById('totalSpent').textContent = API.formatPrice(totalSpent);
            } catch (error) {
                console.error('Erreur lors du chargement des statistiques:', error);
            }
        }

        // Configurer les écouteurs d'événements
        function setupEventListeners() {
            // Validation des mots de passe
            document.getElementById('newPassword').addEventListener('input', validatePasswords);
            document.getElementById('confirmNewPassword').addEventListener('input', validatePasswords);

            // Soumission du formulaire de profil
            document.getElementById('profileForm').addEventListener('submit', async function(e) {
                e.preventDefault();
                
                if (!this.checkValidity()) {
                    e.stopPropagation();
                    this.classList.add('was-validated');
                    return;
                }

                const profileData = {
                    prenom: document.getElementById('editPrenom').value,
                    nom: document.getElementById('editNom').value,
                    telephone: document.getElementById('editTelephone').value
                };

                const button = document.getElementById('saveProfileBtn');
                button.disabled = true;
                button.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>Enregistrement...';

                try {
                    await Auth.updateProfile(profileData);
                    Utils.showSuccess('Profil mis à jour avec succès !');
                    
                    // Mettre à jour l'affichage
                    loadProfileData();
                    Auth.updateNavigation();

                } catch (error) {
                    console.error('Erreur de mise à jour du profil:', error);
                    Utils.showError(this, `Erreur: ${error.message}`);
                } finally {
                    button.disabled = false;
                    button.innerHTML = '<i class="fas fa-save me-2"></i>Enregistrer les modifications';
                }
            });

            // Soumission du formulaire de mot de passe
            document.getElementById('passwordForm').addEventListener('submit', async function(e) {
                e.preventDefault();
                
                validatePasswords();

                if (!this.checkValidity()) {
                    e.stopPropagation();
                    this.classList.add('was-validated');
                    return;
                }

                const passwordData = {
                    currentPassword: document.getElementById('currentPassword').value,
                    newPassword: document.getElementById('newPassword').value
                };

                const button = document.getElementById('changePasswordBtn');
                button.disabled = true;
                button.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>Changement...';

                try {
                    await Auth.changePassword(passwordData);
                    Utils.showSuccess('Mot de passe changé avec succès !');
                    
                    // Réinitialiser le formulaire
                    this.reset();
                    this.classList.remove('was-validated');

                } catch (error) {
                    console.error('Erreur de changement de mot de passe:', error);
                    Utils.showError(this, `Erreur: ${error.message}`);
                } finally {
                    button.disabled = false;
                    button.innerHTML = '<i class="fas fa-key me-2"></i>Changer le mot de passe';
                }
            });
        }

        // Valider la correspondance des mots de passe
        function validatePasswords() {
            const newPassword = document.getElementById('newPassword');
            const confirmPassword = document.getElementById('confirmNewPassword');

            if (newPassword.value !== confirmPassword.value) {
                confirmPassword.setCustomValidity('Les mots de passe ne correspondent pas.');
            } else {
                confirmPassword.setCustomValidity('');
            }
        }

        // Obtenir le texte du rôle
        function getRoleText(role) {
            const roles = {
                'client': 'Client',
                'reception': 'Personnel Réception',
                'menage': 'Personnel Ménage',
                'admin_hotel': 'Administrateur Hôtel',
                'super_admin': 'Super Administrateur'
            };
            return roles[role] || role;
        }
    </script>
</body>
</html>