<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard Admin - TogoHotel Manager</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <link href="../../css/style.css" rel="stylesheet">
</head>
<body>
    <!-- Navigation -->
    <nav class="navbar navbar-expand-lg navbar-dark bg-dark fixed-top">
        <div class="container">
            <a class="navbar-brand" href="../../index.html">
                <i class="fas fa-hotel me-2"></i>TogoHotel Manager
            </a>
            <div class="collapse navbar-collapse">
                <ul class="navbar-nav me-auto">
                    <li class="nav-item">
                        <a class="nav-link" href="../../index.html">Accueil</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="../hotels.html">Hôtels</a>
                    </li>
                </ul>
                <div class="navbar-nav" id="userMenu">
                    <li class="nav-item dropdown">
                        <a class="nav-link dropdown-toggle" href="#" role="button" data-bs-toggle="dropdown">
                            <i class="fas fa-user me-1"></i>
                            <span id="userName"></span>
                        </a>
                        <ul class="dropdown-menu" id="dashboardLinks">
                            <li><a class="dropdown-item active" href="dashboard.html">
                                <i class="fas fa-cog me-2"></i>Dashboard Admin
                            </a></li>
                            <li><hr class="dropdown-divider"></li>
                            <li><a class="dropdown-item" href="#" onclick="Auth.logout()">
                                <i class="fas fa-sign-out-alt me-2"></i>Déconnexion
                            </a></li>
                        </ul>
                    </li>
                </div>
            </div>
        </div>
    </nav>

    <!-- Contenu Principal -->
    <div class="container-fluid mt-5 pt-4">
        <div class="row">
            <!-- Sidebar -->
            <nav class="col-md-3 col-lg-2 d-md-block bg-light sidebar collapse">
                <div class="position-sticky pt-3">
                    <ul class="nav flex-column">
                        <li class="nav-item">
                            <a class="nav-link active" href="#">
                                <i class="fas fa-tachometer-alt me-2"></i>
                                Tableau de bord
                            </a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="#finances">
                                <i class="fas fa-chart-line me-2"></i>
                                Finances
                            </a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="#chambres">
                                <i class="fas fa-bed me-2"></i>
                                Gestion Chambres
                            </a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="#personnel">
                                <i class="fas fa-users me-2"></i>
                                Personnel
                            </a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="#clients">
                                <i class="fas fa-user-friends me-2"></i>
                                Clients
                            </a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="#parametres">
                                <i class="fas fa-cogs me-2"></i>
                                Paramètres
                            </a>
                        </li>
                    </ul>

                    <!-- Section Super Admin -->
                    <div id="superAdminSection" style="display: none;">
                        <hr>
                        <h6 class="sidebar-heading px-3 mt-4 mb-1 text-muted text-uppercase">
                            <i class="fas fa-crown me-1"></i>Super Admin
                        </h6>
                        <ul class="nav flex-column">
                            <li class="nav-item">
                                <a class="nav-link" href="#hotels">
                                    <i class="fas fa-hotel me-2"></i>
                                    Gestion Hôtels
                                </a>
                            </li>
                            <li class="nav-item">
                                <a class="nav-link" href="#utilisateurs">
                                    <i class="fas fa-user-cog me-2"></i>
                                    Utilisateurs
                                </a>
                            </li>
                        </ul>
                    </div>
                </div>
            </nav>

            <!-- Contenu -->
            <main class="col-md-9 ms-sm-auto col-lg-10 px-md-4">
                <!-- En-tête -->
                <div class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pt-3 pb-2 mb-3 border-bottom">
                    <h1 class="h2">
                        <i class="fas fa-cog me-2 text-primary"></i>Dashboard Administration
                    </h1>
                    <div class="btn-toolbar mb-2 mb-md-0">
                        <div class="btn-group me-2">
                            <button class="btn btn-sm btn-outline-secondary" onclick="refreshData()">
                                <i class="fas fa-sync-alt me-1"></i>Actualiser
                            </button>
                            <button class="btn btn-sm btn-outline-primary" onclick="generateReport()">
                                <i class="fas fa-download me-1"></i>Rapport
                            </button>
                        </div>
                    </div>
                </div>

                <!-- KPIs Principaux -->
                <div class="row mb-4">
                    <div class="col-xl-3 col-md-6 mb-4">
                        <div class="card dashboard-card border-start border-primary border-4">
                            <div class="card-body">
                                <div class="row align-items-center">
                                    <div class="col">
                                        <div class="text-xs fw-bold text-primary text-uppercase mb-1">
                                            Chiffre d'Affaires (Mois)
                                        </div>
                                        <div class="h5 mb-0 fw-bold text-gray-800" id="monthlyRevenue">0 FCFA</div>
                                        <div class="mt-2 mb-0 text-xs">
                                            <span class="text-success me-2" id="revenueGrowth">
                                                <i class="fas fa-arrow-up me-1"></i>0%
                                            </span>
                                            <span class="text-muted">vs mois dernier</span>
                                        </div>
                                    </div>
                                    <div class="col-auto">
                                        <i class="fas fa-money-bill-wave fa-2x text-gray-300"></i>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="col-xl-3 col-md-6 mb-4">
                        <div class="card dashboard-card border-start border-success border-4">
                            <div class="card-body">
                                <div class="row align-items-center">
                                    <div class="col">
                                        <div class="text-xs fw-bold text-success text-uppercase mb-1">
                                            Taux d'Occupation
                                        </div>
                                        <div class="h5 mb-0 fw-bold text-gray-800" id="occupancyRate">0%</div>
                                        <div class="mt-2 mb-0 text-xs">
                                            <span class="text-success me-2">
                                                <i class="fas fa-bed me-1"></i>
                                            </span>
                                            <span class="text-muted" id="occupiedRooms">0/0 chambres</span>
                                        </div>
                                    </div>
                                    <div class="col-auto">
                                        <i class="fas fa-bed fa-2x text-gray-300"></i>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="col-xl-3 col-md-6 mb-4">
                        <div class="card dashboard-card border-start border-warning border-4">
                            <div class="card-body">
                                <div class="row align-items-center">
                                    <div class="col">
                                        <div class="text-xs fw-bold text-warning text-uppercase mb-1">
                                            Réservations (Mois)
                                        </div>
                                        <div class="h5 mb-0 fw-bold text-gray-800" id="monthlyBookings">0</div>
                                        <div class="mt-2 mb-0 text-xs">
                                            <span class="text-success me-2" id="bookingsGrowth">
                                                <i class="fas fa-arrow-up me-1"></i>0%
                                            </span>
                                            <span class="text-muted">vs mois dernier</span>
                                        </div>
                                    </div>
                                    <div class="col-auto">
                                        <i class="fas fa-calendar-check fa-2x text-gray-300"></i>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="col-xl-3 col-md-6 mb-4">
                        <div class="card dashboard-card border-start border-info border-4">
                            <div class="card-body">
                                <div class="row align-items-center">
                                    <div class="col">
                                        <div class="text-xs fw-bold text-info text-uppercase mb-1">
                                            Rev. Moyen/Chambre
                                        </div>
                                        <div class="h5 mb-0 fw-bold text-gray-800" id="averageRevenue">0 FCFA</div>
                                        <div class="mt-2 mb-0 text-xs">
                                            <span class="text-success me-2">
                                                <i class="fas fa-chart-line me-1"></i>
                                            </span>
                                            <span class="text-muted">Performance</span>
                                        </div>
                                    </div>
                                    <div class="col-auto">
                                        <i class="fas fa-chart-bar fa-2x text-gray-300"></i>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Graphiques et Statistiques -->
                <div class="row mb-4">
                    <!-- Statistiques de Réservations -->
                    <div class="col-xl-8 col-lg-7">
                        <div class="card mb-4">
                            <div class="card-header">
                                <h6 class="mb-0">
                                    <i class="fas fa-chart-line me-2 text-primary"></i>Évolution des Réservations
                                </h6>
                            </div>
                            <div class="card-body">
                                <div id="bookingsChart" style="height: 300px;">
                                    <!-- Le graphique sera généré ici -->
                                    <div class="text-center py-5">
                                        <i class="fas fa-chart-bar fa-3x text-muted mb-3"></i>
                                        <p class="text-muted">Graphique des réservations</p>
                                        <canvas id="bookingsCanvas" width="400" height="200"></canvas>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Répartition des Chambres -->
                    <div class="col-xl-4 col-lg-5">
                        <div class="card mb-4">
                            <div class="card-header">
                                <h6 class="mb-0">
                                    <i class="fas fa-chart-pie me-2 text-success"></i>Statut des Chambres
                                </h6>
                            </div>
                            <div class="card-body">
                                <div id="roomsChart" style="height: 300px;">
                                    <!-- Le graphique circulaire sera généré ici -->
                                    <div class="text-center py-5">
                                        <i class="fas fa-bed fa-3x text-muted mb-3"></i>
                                        <p class="text-muted">Répartition des chambres</p>
                                        <canvas id="roomsCanvas" width="200" height="200"></canvas>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Dernières Réservations -->
                <div class="card mb-4" id="finances">
                    <div class="card-header">
                        <h5 class="mb-0">
                            <i class="fas fa-money-bill-wave me-2 text-primary"></i>Dernières Réservations
                        </h5>
                    </div>
                    <div class="card-body">
                        <div class="table-responsive">
                            <table class="table table-hover">
                                <thead>
                                    <tr>
                                        <th>Réservation</th>
                                        <th>Client</th>
                                        <th>Chambre</th>
                                        <th>Dates</th>
                                        <th>Montant</th>
                                        <th>Statut</th>
                                    </tr>
                                </thead>
                                <tbody id="recentBookings">
                                    <!-- Les réservations récentes seront chargées ici -->
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>

                <!-- Section Super Admin (Hôtels) -->
                <div class="card mb-4" id="hotels" style="display: none;">
                    <div class="card-header">
                        <h5 class="mb-0">
                            <i class="fas fa-hotel me-2 text-warning"></i>Gestion des Hôtels
                        </h5>
                    </div>
                    <div class="card-body">
                        <div class="table-responsive">
                            <table class="table table-hover">
                                <thead>
                                    <tr>
                                        <th>Hôtel</th>
                                        <th>Ville</th>
                                        <th>Chambres</th>
                                        <th>Taux d'Occupation</th>
                                        <th>CA Total</th>
                                        <th>Statut</th>
                                        <th>Actions</th>
                                    </tr>
                                </thead>
                                <tbody id="hotelsList">
                                    <!-- La liste des hôtels sera chargée ici -->
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </main>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="../../js/auth.js"></script>
    <script src="../../js/api.js"></script>
    <script src="../../js/main.js"></script>
    <script>
        let bookingsChart = null;
        let roomsChart = null;

        // Initialisation
        document.addEventListener('DOMContentLoaded', function() {
            if (!Auth.requireRole(['admin_hotel', 'super_admin'])) return;
            Auth.updateNavigation();
            checkUserRole();
            loadDashboardData();
        });

        // Vérifier le rôle de l'utilisateur
        function checkUserRole() {
            const user = Auth.getUser();
            if (user && user.role === 'super_admin') {
                document.getElementById('superAdminSection').style.display = 'block';
                document.getElementById('hotels').style.display = 'block';
            }
        }

        // Charger les données du dashboard
        async function loadDashboardData() {
            try {
                await Promise.all([
                    loadKPIs(),
                    loadRecentBookings(),
                    loadCharts()
                ]);

                if (Auth.getUser().role === 'super_admin') {
                    await loadHotelsList();
                }

            } catch (error) {
                console.error('Erreur lors du chargement du dashboard:', error);
            }
        }

        // Actualiser les données
        async function refreshData() {
            const refreshBtn = document.querySelector('button[onclick="refreshData()"]');
            const originalHtml = refreshBtn.innerHTML;
            
            refreshBtn.disabled = true;
            refreshBtn.innerHTML = '<i class="fas fa-spinner fa-spin me-1"></i>Actualisation...';

            try {
                await loadDashboardData();
                Utils.showSuccess('Données actualisées !');
            } catch (error) {
                console.error('Erreur lors de l\'actualisation:', error);
            } finally {
                refreshBtn.disabled = false;
                refreshBtn.innerHTML = originalHtml;
            }
        }

        // Générer un rapport
        function generateReport() {
            Utils.showSuccess('Génération du rapport en cours...');
            // Ici, vous pourriez générer un PDF ou exporter des données
            setTimeout(() => {
                Utils.showSuccess('Rapport généré avec succès !');
            }, 2000);
        }

        // Charger les KPIs
        async function loadKPIs() {
            try {
                const stats = await API.getAdminStats();
                
                // Données simulées pour la démonstration
                const monthlyRevenue = 1250000;
                const monthlyBookings = 45;
                const occupiedRooms = stats.occupied_rooms || 0;
                const totalRooms = stats.total_rooms || 1;
                const occupancyRate = Math.round((occupiedRooms / totalRooms) * 100);
                const averageRevenue = Math.round(monthlyRevenue / totalRooms);

                document.getElementById('monthlyRevenue').textContent = API.formatPrice(monthlyRevenue);
                document.getElementById('monthlyBookings').textContent = monthlyBookings;
                document.getElementById('occupancyRate').textContent = occupancyRate + '%';
                document.getElementById('occupiedRooms').textContent = `${occupiedRooms}/${totalRooms} chambres`;
                document.getElementById('averageRevenue').textContent = API.formatPrice(averageRevenue);

                // Croissance simulée
                document.getElementById('revenueGrowth').innerHTML = 
                    '<i class="fas fa-arrow-up me-1"></i>' + Math.floor(Math.random() * 20 + 5) + '%';
                document.getElementById('bookingsGrowth').innerHTML = 
                    '<i class="fas fa-arrow-up me-1"></i>' + Math.floor(Math.random() * 15 + 3) + '%';

            } catch (error) {
                console.error('Erreur lors du chargement des KPIs:', error);
            }
        }

        // Charger les réservations récentes
        async function loadRecentBookings() {
            try {
                // Pour l'admin, nous devrions avoir un endpoint spécifique
                // Pour l'instant, on utilise les données simulées
                const recentBookings = [
                    {
                        numero_reservation: 'RES2024001',
                        client: 'Koffi Mensah',
                        chambre: '201 - Junior',
                        dates: '15-17 Jan 2024',
                        montant: 110000,
                        statut: 'Confirmée'
                    },
                    {
                        numero_reservation: 'RES2024002', 
                        client: 'Afi Johnson',
                        chambre: '301 - Executive',
                        dates: '14-16 Jan 2024',
                        montant: 170000,
                        statut: 'En cours'
                    },
                    {
                        numero_reservation: 'RES2024003',
                        client: 'Jean Dupont',
                        chambre: '101 - Standard', 
                        dates: '16-18 Jan 2024',
                        montant: 70000,
                        statut: 'Confirmée'
                    }
                ];

                displayRecentBookings(recentBookings);

            } catch (error) {
                console.error('Erreur lors du chargement des réservations:', error);
                Utils.showError(document.getElementById('recentBookings'), 
                    'Impossible de charger les réservations récentes.');
            }
        }

        // Afficher les réservations récentes
        function displayRecentBookings(bookings) {
            const container = document.getElementById('recentBookings');
            let html = '';

            bookings.forEach(booking => {
                html += `
                    <tr>
                        <td>
                            <strong>${booking.numero_reservation}</strong>
                        </td>
                        <td>${booking.client}</td>
                        <td>${booking.chambre}</td>
                        <td>${booking.dates}</td>
                        <td>
                            <span class="fw-bold text-primary">${API.formatPrice(booking.montant)}</span>
                        </td>
                        <td>
                            <span class="badge ${getBookingStatusBadge(booking.statut)}">
                                ${booking.statut}
                            </span>
                        </td>
                    </tr>
                `;
            });

            container.innerHTML = html;
        }

        // Charger les graphiques
        function loadCharts() {
            // Données simulées pour les graphiques
            const bookingsData = {
                labels: ['Jan', 'Fév', 'Mar', 'Avr', 'Mai', 'Jun', 'Jul', 'Aoû', 'Sep', 'Oct', 'Nov', 'Déc'],
                datasets: [{
                    label: 'Réservations',
                    data: [35, 42, 38, 45, 52, 48, 60, 55, 58, 62, 65, 70],
                    borderColor: '#0d6efd',
                    backgroundColor: 'rgba(13, 110, 253, 0.1)',
                    tension: 0.4,
                    fill: true
                }]
            };

            const roomsData = {
                labels: ['Disponibles', 'Occupées', 'Nettoyage', 'Maintenance'],
                datasets: [{
                    data: [45, 32, 8, 5],
                    backgroundColor: [
                        '#28a745',
                        '#dc3545', 
                        '#ffc107',
                        '#6c757d'
                    ]
                }]
            };

            // Graphique des réservations
            const bookingsCtx = document.getElementById('bookingsCanvas').getContext('2d');
            if (bookingsChart) bookingsChart.destroy();
            
            bookingsChart = new Chart(bookingsCtx, {
                type: 'line',
                data: bookingsData,
                options: {
                    responsive: true,
                    plugins: {
                        legend: {
                            display: false
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            title: {
                                display: true,
                                text: 'Nombre de réservations'
                            }
                        }
                    }
                }
            });

            // Graphique des chambres
            const roomsCtx = document.getElementById('roomsCanvas').getContext('2d');
            if (roomsChart) roomsChart.destroy();
            
            roomsChart = new Chart(roomsCtx, {
                type: 'doughnut',
                data: roomsData,
                options: {
                    responsive: true,
                    plugins: {
                        legend: {
                            position: 'bottom'
                        }
                    }
                }
            });
        }

        // Charger la liste des hôtels (Super Admin seulement)
        async function loadHotelsList() {
            try {
                const hotels = await API.getAllHotels();
                displayHotelsList(hotels);
            } catch (error) {
                console.error('Erreur lors du chargement des hôtels:', error);
            }
        }

        // Afficher la liste des hôtels
        function displayHotelsList(hotels) {
            const container = document.getElementById('hotelsList');
            let html = '';

            hotels.forEach(hotel => {
                // Données simulées pour la démonstration
                const totalRooms = 60;
                const occupiedRooms = Math.floor(Math.random() * 40 + 10);
                const occupancyRate = Math.round((occupiedRooms / totalRooms) * 100);
                const totalRevenue = Math.floor(Math.random() * 5000000 + 1000000);

                html += `
                    <tr>
                        <td>
                            <strong>${hotel.nom}</strong>
                            <br><small class="text-muted">${hotel.email}</small>
                        </td>
                        <td>${hotel.ville}</td>
                        <td>${totalRooms}</td>
                        <td>
                            <div class="d-flex align-items-center">
                                <div class="progress flex-grow-1 me-2" style="height: 6px;">
                                    <div class="progress-bar bg-success" style="width: ${occupancyRate}%"></div>
                                </div>
                                <span>${occupancyRate}%</span>
                            </div>
                        </td>
                        <td>
                            <span class="fw-bold text-primary">${API.formatPrice(totalRevenue)}</span>
                        </td>
                        <td>
                            <span class="badge ${hotel.statut === 'actif' ? 'bg-success' : 'bg-secondary'}">
                                ${hotel.statut === 'actif' ? 'Actif' : 'Inactif'}
                            </span>
                        </td>
                        <td>
                            <button class="btn btn-sm btn-outline-primary me-1">
                                <i class="fas fa-edit"></i>
                            </button>
                            <button class="btn btn-sm btn-outline-danger">
                                <i class="fas fa-trash"></i>
                            </button>
                        </td>
                    </tr>
                `;
            });

            container.innerHTML = html;
        }

        // Obtenir la classe du badge selon le statut
        function getBookingStatusBadge(status) {
            const classes = {
                'Confirmée': 'bg-success',
                'En cours': 'bg-primary', 
                'Terminée': 'bg-info',
                'Annulée': 'bg-danger'
            };
            return classes[status] || 'bg-secondary';
        }
    </script>

    <style>
        .sidebar {
            min-height: calc(100vh - 76px);
            box-shadow: inset -1px 0 0 rgba(0, 0, 0, .1);
        }
        
        .sidebar .nav-link {
            color: #333;
            padding: 0.75rem 1rem;
            border-radius: 0.375rem;
        }
        
        .sidebar .nav-link.active {
            color: #0d6efd;
            background-color: #e7f1ff;
        }
        
        .sidebar .nav-link:hover {
            color: #0d6efd;
            background-color: #f8f9fa;
        }
        
        .sidebar-heading {
            font-size: .75rem;
        }
        
        .progress {
            background-color: #e9ecef;
        }
    </style>
</body>
</html>